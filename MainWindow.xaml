<Window
    x:Class="VisorDTE.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:views="using:VisorDTE.Views"
    xmlns:viewmodels="using:VisorDTE.ViewModels"
    xmlns:models="using:VisorDTE.Models"
    mc:Ignorable="d"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:converters="using:VisorDTE.Converters"
    xmlns:toolkit="using:CommunityToolkit.WinUI.UI.Controls">

    <Grid x:Name="RootGrid" Loaded="RootGrid_Loaded" Background="{ThemeResource SystemControlPageBackgroundChromeLowBrush}">
        <Grid.Resources>
            <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
            <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        </Grid.Resources>

        <Grid.ColumnDefinitions>
            <ColumnDefinition x:Name="MainContentColumn" Width="*"/>
            <ColumnDefinition x:Name="InspectorColumn" Width="0" MinWidth="0"/>
        </Grid.ColumnDefinitions>

        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0"
                Background="{ThemeResource SystemAccentColor}"
                Margin="12,8,12,10"
                CornerRadius="8">
                <StackPanel Orientation="Horizontal" Spacing="12">
                    <Border CornerRadius="5" Margin="12">
                        <Image Source="{ThemeResource AppLogoBitmap}" Height="72" Width="72" VerticalAlignment="Center"/>
                    </Border>
                    <TextBlock x:Name="HeaderTitleTextBlock" 
                               Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}" 
                               FontSize="20" FontWeight="SemiBold" VerticalAlignment="Center"/>
                </StackPanel>
            </Border>

            <CommandBar Grid.Row="1" DefaultLabelPosition="Right">
                <AppBarButton Icon="OpenFile" Label="Abrir DTE" Command="{Binding OpenFilesCommand}"/>
                <AppBarButton Icon="Save" Label="Exportar a PDF" Command="{Binding ExportToPdfCommand}"/>
                <AppBarButton Icon="Document" Label="Anexo F07" Command="{Binding ExportF07AnexoCommand}"/>
                <AppBarSeparator/>
                <AppBarButton Icon="PreviewLink" Label="{Binding ToggleInspectorLabel}" Command="{Binding ToggleInspectorCommand}"/>
                <CommandBar.SecondaryCommands>
                    <AppBarButton Icon="Setting" Label="Configuración" Command="{Binding ShowSettingsDialogCommand}"/>
                    <AppBarButton Icon="Shop" Label="Complementos (Add-ons)" Command="{Binding ShowPurchaseAddonsDialogCommand}"/>
                    <AppBarButton Icon="Help" Label="Acerca de..." Command="{Binding ShowAboutDialogCommand}"/>
                </CommandBar.SecondaryCommands>
                <CommandBar.Content>
                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                        <AutoSuggestBox QueryIcon="Find" PlaceholderText="Buscar por Número de Control..." Text="{Binding SearchQuery, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" MinWidth="300"/>
                        <Button Command="{Binding PasteSearchCommand}" ToolTipService.ToolTip="Pegar">
                            <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE77F;"/>
                        </Button>
                    </StackPanel>
                </CommandBar.Content>
            </CommandBar>

            <muxc:TabView Grid.Row="2" Margin="0,-1,0,0">
                <muxc:TabView.TabItems>
                    <muxc:TabViewItem Header="Vista por Página" IsClosable="False">
                        <FlipView ItemsSource="{Binding DteViewModels}" SelectedItem="{Binding SelectedDte, Mode=TwoWay}"
                                  PointerWheelChanged="FlipView_PointerWheelChanged"
                                  ItemTemplateSelector="{StaticResource DteTemplateSelector}"/>
                    </muxc:TabViewItem>
                    <muxc:TabViewItem Header="Documento Completo" IsClosable="False">
                        <ListView ItemsSource="{Binding DteViewModels}" SelectionMode="Single"
                                  SelectionChanged="ListView_SelectionChanged"
                                  ItemTemplateSelector="{StaticResource DteTemplateSelector}"/>
                    </muxc:TabViewItem>
                </muxc:TabView.TabItems>
            </muxc:TabView>

            <Grid Grid.Row="3" Padding="12,8" ColumnDefinitions="*,Auto" Background="{ThemeResource SystemControlBackgroundBaseLowBrush}">
                <TextBlock Grid.Column="0" Text="{Binding StatusText}" VerticalAlignment="Center" Foreground="Gray"/>
            </Grid>
        </Grid>

        <Border Grid.Column="1" x:Name="JsonViewerPanel" Background="{ThemeResource SystemControlBackgroundBaseLowBrush}"
                Visibility="{Binding IsInspectorVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Margin="12,12,12,0">
                    <TextBlock Grid.Column="0" Text="Inspector de Propiedades" FontWeight="Bold" VerticalAlignment="Center" Margin="10,0,0,0"/>
                    <Button Grid.Column="1" 
                            Content="{Binding ToggleExpandCollapseLabel}" 
                            Command="{Binding ToggleExpandCollapseCommand}" 
                            HorizontalAlignment="Right"
                            Style="{ThemeResource AccentButtonStyle}"/>
                    <Button Grid.Column="2" Command="{Binding ToggleInspectorCommand}" Background="Transparent" BorderThickness="0" Padding="8">
                        <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE8BB;" FontSize="12"/>
                    </Button>
                </Grid>
                <ScrollViewer x:Name="InspectorScrollViewer" Grid.Row="1" Margin="0,12,0,0" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                    <muxc:TreeView x:Name="InspectorTreeView" ItemsSource="{Binding JsonTreeNodes}">
                        <muxc:TreeView.ItemTemplate>
                            <DataTemplate x:DataType="models:JsonPropertyNode">
                                <muxc:TreeViewItem ItemsSource="{Binding Children}" IsExpanded="{Binding DataContext.IsTreeExpanded, ElementName=RootGrid, Mode=OneWay}">
                                    <Grid ColumnDefinitions="Auto,Auto,*" VerticalAlignment="Center">
                                        <Button Grid.Column="0"
                                                Style="{StaticResource CopyButtonStyle}"
                                                Click="CopyButton_Click"
                                                DataContext="{Binding}"
                                                Visibility="{Binding Value, Converter={StaticResource NullToVisibilityConverter}}"/>
                                        <TextBlock Grid.Column="1" Text="{Binding PropertyName}" FontWeight="SemiBold" Margin="4,0,8,0" VerticalAlignment="Center" Foreground="{ThemeResource SystemControlForegroundBaseHighBrush}"/>
                                        <TextBox Grid.Column="2" Text="{Binding Value}" IsReadOnly="True" BorderThickness="0" TextWrapping="NoWrap" Background="Transparent" VerticalAlignment="Center" Foreground="{ThemeResource SystemControlForegroundBaseHighBrush}"/>
                                    </Grid>
                                </muxc:TreeViewItem>
                            </DataTemplate>
                        </muxc:TreeView.ItemTemplate>
                    </muxc:TreeView>
                </ScrollViewer>
            </Grid>
        </Border>

        <toolkit:GridSplitter Grid.Column="1" Width="8" ResizeBehavior="BasedOnAlignment"
                              ResizeDirection="Auto"
                              Background="{ThemeResource SystemControlPageBackgroundBaseLowBrush}"
                              HorizontalAlignment="Left"
                              Visibility="{Binding IsInspectorVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
    </Grid>
</Window>